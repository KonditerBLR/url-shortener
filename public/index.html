<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CutTo - Профессиональное сокращение ссылок</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 48px; margin-bottom: 10px; }
        .header p { font-size: 18px; opacity: 0.9; }
        .auth-bar { max-width: 1200px; margin: 0 auto 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .auth-bar button { padding: 10px 20px; background: white; color: #667eea; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .auth-bar .user-info { background: white; padding: 10px 20px; border-radius: 8px; color: #667eea; font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 400px 1fr; gap: 30px; }
        @media (max-width: 968px) { .container { grid-template-columns: 1fr; } }
        .card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); padding: 30px; }
        .card h2 { color: #667eea; margin-bottom: 20px; font-size: 24px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; font-size: 14px; }
        input[type="text"], input[type="email"], input[type="password"] { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 15px; transition: border-color 0.3s; }
        input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        .result { display: none; margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 10px; }
        .result.show { display: block; }
        .short-url input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 15px; color: #333; font-weight: 500; margin-bottom: 10px; }
        .copy-btn { padding: 10px; background: #667eea; }
        .qr-code { text-align: center; margin-top: 15px; }
        .qr-code img { max-width: 150px; border-radius: 10px; }
        .error, .success { display: none; padding: 12px; border-radius: 10px; margin-top: 12px; font-size: 14px; }
        .error { background: #fee; border: 1px solid #fcc; color: #c33; }
        .success { background: #efe; border: 1px solid #cfc; color: #3c3; }
        .error.show, .success.show { display: block; }
        .links-list { max-height: 600px; overflow-y: auto; }
        .link-item { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 4px solid #667eea; position: relative; padding-right: 100px; }
        .link-item .url { font-size: 13px; color: #666; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 100px); }
        .link-item .short { font-size: 15px; color: #667eea; font-weight: 600; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: calc(100% - 100px); cursor: pointer; }
        .link-item .stats { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: #999; max-width: calc(100% - 100px); }
        .link-item .clicks { background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; }
        .link-item .delete-btn { position: absolute; top: 15px; right: 15px; background: #ff4444; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state svg { width: 80px; height: 80px; margin-bottom: 15px; opacity: 0.3; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; max-width: 400px; width: 90%; }
        .modal-content h2 { margin-bottom: 20px; color: #667eea; }
        .modal-content button { margin-top: 10px; }
        .switch-btn { background: none; color: #667eea; text-decoration: underline; cursor: pointer; font-size: 14px; padding: 0; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>✨ CutTo</h1>
        <p>Профессиональное сокращение ссылок с аналитикой</p>
    </div>
    
    <div class="auth-bar" id="authBar">
        <button onclick="showLoginModal()">Войти</button>
        <button onclick="showRegisterModal()">Регистрация</button>
    </div>
    
    <div class="container">
        <div class="card">
            <h2>Создать короткую ссылку</h2>
            <div class="input-group">
                <label for="urlInput">Введите длинную ссылку:</label>
                <input type="text" id="urlInput" placeholder="https://example.com/very/long/url">
            </div>
            <button id="shortenBtn">Создать короткую ссылку</button>
            <div class="error" id="error"></div>
            <div class="result" id="result">
                <h3 style="margin-bottom: 12px; color: #333; font-size: 16px;">✅ Ссылка создана!</h3>
                <div class="short-url">
                    <input type="text" id="shortUrlInput" readonly>
                    <button class="copy-btn" id="copyBtn">Копировать</button>
                </div>
                <div class="qr-code">
                    <p style="margin-bottom: 8px; color: #666; font-size: 13px;">QR-код:</p>
                    <img id="qrCodeImg" src="" alt="QR Code">
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Ваши ссылки</h2>
            <div class="links-list" id="linksList">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                    <p>Пока нет созданных ссылок</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2 id="modalTitle">Вход</h2>
            <div class="input-group">
                <label for="authEmail">Email:</label>
                <input type="email" id="authEmail" placeholder="your@email.com">
            </div>
            <div class="input-group">
                <label for="authPassword">Пароль:</label>
                <input type="password" id="authPassword" placeholder="Минимум 6 символов">
            </div>
            <div class="error" id="authError"></div>
            <div class="success" id="authSuccess"></div>
            <button id="authSubmitBtn">Войти</button>
            <button class="switch-btn" id="switchBtn">Нет аккаунта? Зарегистрироваться</button>
            <button class="switch-btn" onclick="closeAuthModal()">Закрыть</button>
        </div>
    </div>
    
    <script>
        let allLinks = [];
        let isLoginMode = true;
        let token = localStorage.getItem('token');
        let currentUser = null;
        
        if (token) {
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                currentUser = payload;
                updateAuthBar();
            } catch (e) {
                localStorage.removeItem('token');
            }
        }
        
        function updateAuthBar() {
            const authBar = document.getElementById('authBar');
            if (currentUser) {
                authBar.innerHTML = `
                    <div class="user-info">${currentUser.email}</div>
                    <button onclick="logout()">Выйти</button>
                `;
            } else {
                authBar.innerHTML = `
                    <button onclick="showLoginModal()">Войти</button>
                    <button onclick="showRegisterModal()">Регистрация</button>
                `;
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            updateAuthBar();
            loadLinks();
        }
        
        function showLoginModal() {
            isLoginMode = true;
            document.getElementById('modalTitle').textContent = 'Вход';
            document.getElementById('authSubmitBtn').textContent = 'Войти';
            document.getElementById('switchBtn').textContent = 'Нет аккаунта? Зарегистрироваться';
            document.getElementById('authModal').classList.add('show');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        }
        
        function showRegisterModal() {
            isLoginMode = false;
            document.getElementById('modalTitle').textContent = 'Регистрация';
            document.getElementById('authSubmitBtn').textContent = 'Зарегистрироваться';
            document.getElementById('switchBtn').textContent = 'Уже есть аккаунт? Войти';
            document.getElementById('authModal').classList.add('show');
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').classList.remove('show');
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
        }
        
        document.getElementById('switchBtn').addEventListener('click', function() {
            if (isLoginMode) {
                showRegisterModal();
            } else {
                showLoginModal();
            }
        });
        
        document.getElementById('authSubmitBtn').addEventListener('click', async function() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const errorDiv = document.getElementById('authError');
            const successDiv = document.getElementById('authSuccess');
            
            errorDiv.classList.remove('show');
            successDiv.classList.remove('show');
            
            if (!email || !password) {
                errorDiv.textContent = 'Заполните все поля';
                errorDiv.classList.add('show');
                return;
            }
            
            try {
                const endpoint = isLoginMode ? '/api/auth/login' : '/api/auth/register';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    localStorage.setItem('token', data.token);
                    token = data.token;
                    currentUser = data.user;
                    successDiv.textContent = isLoginMode ? 'Вход выполнен!' : 'Регистрация успешна!';
                    successDiv.classList.add('show');
                    updateAuthBar();
                    setTimeout(() => {
                        closeAuthModal();
                        loadLinks();
                    }, 1000);
                } else {
                    errorDiv.textContent = data.error;
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка соединения';
                errorDiv.classList.add('show');
            }
        });
        
        async function loadLinks() {
            try {
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch('/api/links', { headers });
                const data = await response.json();
                allLinks = data.links || [];
                renderLinks();
            } catch (error) {
                console.error('Error loading links:', error);
            }
        }
        
        function renderLinks() {
            const container = document.getElementById('linksList');
            if (allLinks.length === 0) {
                container.innerHTML = '<div class="empty-state"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg><p>Пока нет созданных ссылок</p></div>';
                return;
            }
            container.innerHTML = allLinks.map(link => `
                <div class="link-item">
                    ${currentUser ? `<button class="delete-btn" onclick="deleteLink('${link.short_code}')">Удалить</button>` : ''}
                    <div class="url" title="${link.original_url}">${link.original_url}</div>
                    <div class="short" onclick="copyShortLink('${window.location.origin}/${link.short_code}')" title="Нажмите, чтобы скопировать">${window.location.origin}/${link.short_code}</div>
                    <div class="stats">
                        <span>${new Date(link.created_at).toLocaleDateString('ru-RU')}</span>
                        <span class="clicks">${link.clicks || 0} ${link.clicks === 1 ? 'клик' : 'кликов'}</span>
                    </div>
                </div>
            `).join('');
        }
        
        async function deleteLink(shortCode) {
            if (!confirm('Удалить эту ссылку?')) return;
            
            try {
                const response = await fetch(`/api/links/${shortCode}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    loadLinks();
                }
            } catch (error) {
                alert('Ошибка удаления');
            }
        }
        
        function copyShortLink(url) {
            navigator.clipboard.writeText(url).then(() => {
                alert('Ссылка скопирована!');
            });
        }
        
        document.getElementById('shortenBtn').addEventListener('click', async function() {
            const url = document.getElementById('urlInput').value;
            const errorDiv = document.getElementById('error');
            const resultDiv = document.getElementById('result');
            errorDiv.classList.remove('show');
            resultDiv.classList.remove('show');
            if (!url) {
                errorDiv.textContent = 'Пожалуйста, введите URL';
                errorDiv.classList.add('show');
                return;
            }
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                const response = await fetch('/api/shorten', {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({ url })
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('shortUrlInput').value = data.shortUrl;
                    document.getElementById('qrCodeImg').src = data.qrCode;
                    resultDiv.classList.add('show');
                    document.getElementById('urlInput').value = '';
                    loadLinks();
                } else {
                    errorDiv.textContent = data.error || 'Произошла ошибка';
                    errorDiv.classList.add('show');
                }
            } catch (error) {
                errorDiv.textContent = 'Ошибка соединения';
                errorDiv.classList.add('show');
            }
        });
        
        document.getElementById('copyBtn').addEventListener('click', function() {
            const input = document.getElementById('shortUrlInput');
            input.select();
            navigator.clipboard.writeText(input.value).then(() => {
                this.textContent = '✓ Скопировано';
                setTimeout(() => { this.textContent = 'Копировать'; }, 2000);
            });
        });
        
        document.getElementById('urlInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') document.getElementById('shortenBtn').click();
        });
        
        loadLinks();
    </script>
</body>
</html>